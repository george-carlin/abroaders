<% provide :title, "#{@person.first_name} - Recommend Card" %>

<% content_for :header_panel do %>
  <div class="panel-body">
    <h1><%= @person.first_name %> - Recommend Card</h1>
    <p>
      <%= @person.account.email %> -
      Account created on <%= @person.signed_up.strftime("%D") %>
    </p>
  </div>
<% end %>


<%= render "shared/hpanel" do %>
  <div class="panel-body">

    <div class="col-xs-12 col-md-6">
      <%= render "spending_infos/spending_info", spending_info: @spending_info %>
    </div>
    <div class="col-xs-12 col-md-6">
      <% if @balances.any? %>
        <h3>Existing Balances</h3>

        <ul class="person-balances">
          <% @balances.each do |balance| %>
            <li id="<%= dom_id(balance.currency) %>">
              <b><%= balance.currency_name %>:</b>
              <span class="balance"><%= number_with_delimiter(balance.value) %></span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <%= t("admin.people.card_recommendations.no_balances") %>
      <% end # balances.any? %>
    </div><!-- .col-xs-12.col-md-6 -->

    <div class="col-xs-12 col-md-6">
      <% if @travel_plans.any? %>
        <h3>Travel Plans</h3>

        <div class="account_travel_plans">
          <%= render collection: @travel_plans, partial: "travel_plans/travel_plan" %>
        </div>
      <% else %>
        User has no upcoming travel plans
      <% end %>
    </div><!-- .col-xs-12.col-md-6 -->
  </div><!-- .panel-body -->
<% end %>

<%= render "shared/hpanel" do %>
  <div class="panel-body">
    <% if @card_accounts.any? %>
      <h3>Existing Cards</h3>

      <%= render "card_accounts/table", accounts: @card_accounts %>
    <% else %>
      <%= t("admin.people.card_accounts.none") %>
    <% end %>
  </div>
<% end %>

<%= render "shared/hpanel" do %>
  <div class="panel-body">
    <div class="card-recommendation-filters">
      <div class="form-inline">
        <b>B/P: </b>&nbsp;
        <% Card.bps.keys.each do |bp| %>
          <%= card_bp_filter_check_box_tag(bp) %>
        <% end %>
      </div>

      <div class="form-inline">
        <b>BANK: </b>&nbsp;
        <% Bank.all.each do |bank| %>
          <%= card_bank_filter_check_box_tag(bank) %>
        <% end %>

        |

        <label for="card_bank_filter_all">
          <%= check_box_tag :card_bank_filter_all, nil, true %>
          Toggle all
        </label>
      </div>

      <div class="form-inline">
        <b>CURRENCY: </b>&nbsp;
        <% Currency.order(:name).each do |currency| %>
          <%= card_currency_filter_check_box_tag(currency) %>
        <% end %>

        <!--
        |

        <label for="card_currency_filter_all">
          <%#= check_box_tag :card_currency_filter_all, nil, true %>
          Toggle all
        </label>-->
      </div>
    </div><!-- .card-recommendation-filters -->

    <br>

    <div class="row">
      <div class="col-xs-12">
        <%= button_to(
          "Done",
          complete_admin_person_card_recommendations_path(@person),
          class: "btn btn-primary btn-lg",
          style: "float:right;"
        ) %>

        When you're finished recommending cards to this user, click 'Done' to
        send them a notification.

      <% if @person.last_recommendations_at.present? %>
        <br>
        Person last received recommendations on:
        <span class="person_last_recommendations_at">
          <%= @person.last_recommendations_at.strftime("%D") %>
        </span>
      <% end %>
      </div>
    </div>

    <hr>

    <%# TODO - make the table sortable again %>
    <table
      class="admin-card-recommendation-table table"
      cellpadding="1"
      cellspacing="1"
    >

      <thead class="admin-card-recommendations-table-head">
        <tr>
          <th class="card-identifier">
            Identifier
          </th>
          <th class="card-name">
            Name
          </th>
          <th class="card-bank-name">
            Bank
          </th>
          <th class="card-bp">
            B/P
          </th>
          <th class="card-currency">
            Currency
          </th>
        </tr>
      </thead>

      <tbody>
        <% @offers_grouped_by_card.each do |card, offers| %>
          <tr
            id="<%= dom_id(card, :admin_recommend) %>"
            class="<%= dom_class(card, :admin_recommend) %>"
            data-bp="<%= card.bp %>"
            data-bank="<%= card.bank_id %>"
            data-currency="<%= card.currency_id %>"
          >
            <% present card do |card_p| %>
              <td class="card-identifier">
                Card <%= card_p.identifier %>
              </td>
              <td class="card-name">
                <%= card_p.name %>
              </td>
              <td class="card-bank-name">
                <%= card_p.bank_name %>
              </td>
              <td class="card-bp">
                <%= card_p.bp %>
              </td>
              <td class="card-currency">
                <%= card_p.currency_name %>
              </td>
            <% end %>
          </tr><!-- .admin_recommend_card_(id) -->

          <tr
            id="<%= dom_id(card, :admin_recommend) %>_offers"
            class="<%= dom_class(card, :admin_recommend) %>_offers"
          >
            <td colspan="5">
              <table
                id="<%= dom_id(card, :admin_recommend) %>_offers_table"
                class="<%= dom_class(card, :admin_recommend) %>_offers_table table"
                cellpadding="1"
                cellspacing="1"
              >
                <tbody>
                  <% present_each offers do |offer| %>
                    <tr
                      id="<%= dom_id(offer, :admin_recommend) %>"
                      class="<%= dom_class(offer, :admin_recommend) %>"
                    >
                      <td class="offer-identifier">
                        <%= offer.identifier %>
                      </td>
                      <td class="offer-points-awarded">
                        Points: &nbsp;
                        <b><%= offer.points_awarded %></b>
                      </td>
                      <td class="offer-spend">
                        Spend:&nbsp;
                        <b><%= offer.spend %></b>
                      </td>
                      <td class="offer-cost">
                        Cost:&nbsp;
                        <b><%= offer.cost %></b>
                      </td>
                      <td class="offer-days">
                        Days:&nbsp;
                        <b><%= offer.days %></b>
                      </td>
                      <td class="offer-link">
                        <b><%= link_to "Link", offer.link, target: "_blank" %></b>
                      </td>
                      <td class="offer-recommend">
                        <%= offer.recommend_btn %>

                        <div
                          class="confirm_cancel_offer_wrapper"
                          style="display:none;"
                          role="group"
                        >
                          <%= offer.confirm_recommend_btn(@person) %>
                          <%= offer.cancel_recommend_btn %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </td>
          </tr><!-- .admin_recommend_card_(id) -->
        <% end %>
      </tbody>
    </table><!-- .admin-card-recommendation-table -->
  </div>
<% end %>
